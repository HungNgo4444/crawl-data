# Story 2.2: Multi-keyword OR Search

## Status

Done

**Validated:** 2025-09-11 16:45 UTC  
**Validation Result:** READY - All checklist requirements passed (5/5 sections: PASS)  
**Validator:** Bob (Scrum Master) using Story Draft Checklist v1.0

## Story

**As a** system,
**I want** to search Google News với multiple keywords using OR logic,
**so that** I có thể crawl articles matching any of the specified keywords.

## Acceptance Criteria

1. Modify crawler để accept array of keywords
2. Implement OR logic cho Google News search queries
3. Handle search result pagination
4. Avoid duplicate articles across keyword searches
5. Associate crawled articles với correct categories

## Tasks / Subtasks

- [ ] Task 1: Enhance Google News search query building (AC: 1, 2)
  - [ ] Update CrawlerEngine.search_google_news method để accept multiple keywords
  - [ ] Modify build_search_query method để properly format OR logic queries  
  - [ ] Add support for complex queries với exclude keywords
  - [ ] Add query validation and sanitization logic
  - [ ] Update logging để track complex queries being executed

- [ ] Task 2: Implement pagination handling (AC: 3)  
  - [ ] Add pagination support trong GoogleNewsSource integration
  - [ ] Implement result fetching across multiple pages
  - [ ] Add configurable limits cho maximum results per search
  - [ ] Handle pagination errors and empty results gracefully
  - [ ] Add metrics tracking cho pagination performance

- [ ] Task 3: Enhance deduplication mechanism (AC: 4)
  - [ ] Update ArticleRepository.bulk_create_with_deduplication method 
  - [ ] Improve URL hash-based deduplication across multiple keyword searches
  - [ ] Add content similarity detection cho near-duplicate articles
  - [ ] Optimize deduplication queries cho better performance
  - [ ] Add deduplication statistics trong crawl results

- [ ] Task 4: Improve category association logic (AC: 5)
  - [ ] Update category association trong CrawlerEngine.save_articles_with_deduplication
  - [ ] Add relevance scoring based on keyword matching
  - [ ] Handle articles that match multiple categories
  - [ ] Implement many-to-many article-category relationships properly
  - [ ] Add category matching validation and logging

- [ ] Task 5: Create comprehensive unit tests và integration tests
  - [ ] Update tests/unit/test_core/test_crawler/test_engine.py với new multi-keyword scenarios
  - [ ] Test OR logic query building với various keyword combinations
  - [ ] Test pagination handling với mock GoogleNewsSource responses
  - [ ] Test deduplication logic với articles from different keyword searches
  - [ ] Test category association logic với multiple matching categories
  - [ ] Create integration tests cho complete multi-keyword crawl workflow

## Dev Notes

### Previous Story Insights

From Story 2.1 (Category CRUD Operations):
- CategoryManager class is established with complete business logic validation
- CategoryRepository with specialized CRUD methods exists in src/database/repositories/category_repo.py
- Category model supports keywords array and exclude_keywords for OR search logic
- build_search_query method exists but needs enhancement for complex OR queries
- Comprehensive validation logic for keywords (1-20 items, max 100 chars each)
- Database category association patterns are established

From Story 1.3 (Basic Google News Crawler):
- CrawlerEngine class exists with basic Google News integration in src/core/crawler/engine.py
- GoogleNewsSource integration is working but limited to simple queries
- ArticleExtractor integration is complete for content extraction
- Basic deduplication logic using URL hashes is implemented
- Async/await patterns throughout with proper transaction handling  
- Rate limiting interface exists but needs enhancement for complex searches
- Structured logging với correlation IDs pattern is established

### Data Models

**Source: [architecture/data-models.md#Article]**

**Article Fields for Enhanced Storage:**
- url_hash: str (required) - SHA-256 hash của source_url for primary deduplication
- content_hash: str (nullable) - SHA-256 hash của content for similarity detection
- relevance_score: float (nullable) - Score indicating how well article matches search keywords
- source_category_ids: list[UUID] - Array of category IDs that led to this article's discovery

**ArticleCategory Junction Table Enhancement:**
- relevance_score: float (0.0-1.0) - How well the article matches the category keywords
- keyword_matched: str (nullable) - Specific keyword that led to the article discovery
- search_query_used: str (nullable) - The actual OR search query that found this article

**Category Fields for OR Logic:**
- keywords: list[str] - Primary keywords for OR search logic: "python OR javascript OR AI"
- exclude_keywords: list[str] - Keywords to exclude: "-java -php"
- search_complexity: enum - Simple, Complex, Advanced based on query complexity

### API Specifications

**Source: [architecture/external-apis.md#Google News API]**

**Enhanced Google News Integration:**
- Multiple keyword OR queries: `(python OR javascript OR AI) -java -php`
- Search result pagination support với limit and offset parameters
- Rate limiting: Conservative approach ~1-2 requests/second for complex queries
- CloudScraper support để bypass Cloudflare protection

**GoogleNewsSource Enhancement Requirements:**
```python
# Enhanced search method signature
async def search_multi_keyword(
    keywords: List[str],
    exclude_keywords: Optional[List[str]] = None,
    max_results: int = 100,
    language: str = "en",
    country: str = "US"
) -> List[Dict]:
    # Implementation needed
```

**Query Building Strategy:**
```python
def build_advanced_search_query(keywords: List[str], exclude_keywords: List[str] = None) -> str:
    # Build OR query: "(python OR javascript OR AI)"
    if len(keywords) == 1:
        base_query = keywords[0]
    else:
        base_query = f"({' OR '.join(keywords)})"
    
    # Add exclusions: "-java -php"
    if exclude_keywords:
        exclude_part = " ".join([f"-{kw}" for kw in exclude_keywords])
        return f"{base_query} {exclude_part}"
    
    return base_query
```

### Component Specifications

**Source: [architecture/source-tree.md] & [architecture/backend-architecture.md]**

**Files to Modify:**
- `src/core/crawler/engine.py` - Main CrawlerEngine class enhancements
- `src/database/repositories/article_repo.py` - Enhanced deduplication methods
- `src/core/category/manager.py` - Enhanced search query building
- `tests/unit/test_core/test_crawler/test_engine.py` - Updated tests

**Enhanced CrawlerEngine Architecture:**
```python
class CrawlerEngine:
    async def search_google_news_multi_keyword(
        self, 
        keywords: List[str], 
        exclude_keywords: List[str] = None,
        max_results: int = 100
    ) -> List[str]:
        """Enhanced multi-keyword OR search với pagination"""
        
    async def crawl_category_advanced(self, category: Category) -> List[Article]:
        """Enhanced category crawling với complex OR logic"""
        
    def calculate_relevance_score(
        self, 
        article_content: str, 
        keywords: List[str]
    ) -> float:
        """Calculate how well article matches keywords"""
```

**Enhanced ArticleRepository Methods:**
```python
class ArticleRepository(BaseRepository[Article]):
    async def bulk_create_with_enhanced_deduplication(
        self,
        articles_data: List[dict],
        category_id: UUID,
        keyword_matched: str,
        search_query_used: str
    ) -> Tuple[int, int, int]:  # (new_articles, updated_articles, duplicates_skipped)
        """Enhanced bulk insert với detailed deduplication tracking"""
        
    async def find_similar_articles_by_content(
        self,
        content_hash: str,
        similarity_threshold: float = 0.8
    ) -> List[Article]:
        """Find articles với similar content using content hashes"""
```

### Technical Constraints

**Source: [architecture/tech-stack.md] & [architecture/coding-standards.md]**

**Performance Requirements:**
- **Pagination Limits:** Maximum 100 results per search query để avoid memory issues
- **Rate Limiting:** Enhanced rate limiting for complex queries (1 request per 2 seconds)
- **Deduplication Performance:** Batch process deduplication trong chunks of 50 articles
- **Database Transactions:** All enhanced operations trong async context managers

**Query Complexity Handling:**
- **Simple Queries:** Single keyword - direct search
- **Medium Queries:** 2-5 keywords với OR logic - standard processing  
- **Complex Queries:** 6+ keywords với excludes - enhanced rate limiting and pagination

**Memory Management:**
- **Batch Processing:** Process search results trong batches to prevent memory exhaustion
- **Result Limiting:** Configurable maximum results per category (default: 200)
- **Cleanup:** Periodic cleanup of old search results and unused article content

### Testing Requirements

**Source: [architecture/testing-strategy.md]**

**Enhanced Test Files:**
- **Unit tests:** `tests/unit/test_core/test_crawler/test_engine.py` - Add multi-keyword test scenarios
- **Repository tests:** `tests/unit/test_database/test_repositories/test_article_repo.py` - Enhanced deduplication tests
- **Integration tests:** `tests/integration/test_crawler_integration.py` - Complex workflow testing

**Specific Testing Requirements:**
- Test multi-keyword OR query building với various combinations (2, 5, 10, 20 keywords)
- Test exclude keywords functionality với different exclusion patterns
- Test pagination handling với mock responses containing multiple pages
- Test deduplication logic với articles found through different keyword searches
- Test relevance scoring algorithm với various article content scenarios  
- Test category association với articles matching multiple categories
- Test performance với large keyword lists (stress testing)
- Test error handling cho malformed queries and API failures
- Test rate limiting compliance với complex queries

**Testing Patterns:**
```python
# Multi-keyword OR testing
def test_multi_keyword_or_search_with_five_keywords(self, crawler_engine):
    keywords = ["python", "javascript", "golang", "rust", "java"]
    query = crawler_engine.build_advanced_search_query(keywords)
    expected = "(python OR javascript OR golang OR rust OR java)"
    assert query == expected

def test_complex_query_with_exclusions(self, crawler_engine):
    keywords = ["AI", "machine learning", "deep learning"]
    exclude_keywords = ["cryptocurrency", "bitcoin"]
    query = crawler_engine.build_advanced_search_query(keywords, exclude_keywords)
    expected = "(AI OR machine learning OR deep learning) -cryptocurrency -bitcoin"
    assert query == expected
```

**Mock Data Requirements:**
- Create realistic GoogleNewsSource responses với multiple pages
- Generate test article content với varying keyword match relevance
- Create test categories với different keyword complexity levels
- Mock rate limiter behavior cho different query types

### Project Structure Alignment

**Source: [architecture/unified-project-structure.md]**

**No New Files Required** - All enhancements will be made to existing files:

**Existing Files to Enhance:**
- `src/core/crawler/engine.py` - Add multi-keyword methods và enhanced logic
- `src/database/repositories/article_repo.py` - Enhanced deduplication and similarity detection
- `src/core/category/manager.py` - Enhanced query building methods
- `src/shared/exceptions.py` - Add complex query validation exceptions if needed

**Testing Files to Enhance:**
- `tests/unit/test_core/test_crawler/test_engine.py` - Add comprehensive multi-keyword testing
- `tests/unit/test_database/test_repositories/test_article_repo.py` - Enhanced deduplication tests
- `tests/integration/test_crawler_integration.py` - Complex workflow integration testing

**Configuration Updates:**
- Update settings trong `src/shared/config.py` để include new pagination and rate limiting parameters:
  - `MAX_RESULTS_PER_SEARCH`: Default 100
  - `COMPLEX_QUERY_RATE_LIMIT`: Default 0.5 requests/second
  - `PAGINATION_BATCH_SIZE`: Default 25 results per page
  - `SIMILARITY_THRESHOLD`: Default 0.8 for content deduplication

## Testing

**Test File Locations:**
- `tests/unit/test_core/test_crawler/test_engine.py` - Enhanced crawler engine testing
- `tests/unit/test_database/test_repositories/test_article_repo.py` - Enhanced repository testing  
- `tests/integration/test_crawler_integration.py` - Complex multi-keyword workflow testing

**Testing Frameworks:** pytest 7.4+ với pytest-asyncio for async operations, unittest.mock.AsyncMock for complex mocking

**Testing Strategy:**
- **Unit Testing:** Mock GoogleNewsSource responses với realistic multi-keyword search results
- **Integration Testing:** End-to-end testing với actual multi-keyword category crawling
- **Performance Testing:** Load testing với complex queries and large result sets
- **Deduplication Testing:** Extensive testing of enhanced deduplication logic

**Key Test Scenarios:**
- Multi-keyword OR queries với 2, 5, 10, and 20 keywords  
- Complex queries với exclude keywords and special characters
- Pagination handling với articles spanning multiple pages
- Deduplication across different keyword searches finding same articles
- Category association với articles matching multiple categories
- Relevance scoring accuracy với varying content matches
- Rate limiting compliance với rapid complex queries
- Error recovery từ malformed queries and API failures
- Memory usage với large search results and complex processing

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Task Completion Status
All tasks completed successfully:
- [x] Task 1: Enhance Google News search query building (AC: 1, 2)
  - [x] Update CrawlerEngine.search_google_news method to accept multiple keywords
  - [x] Modify build_search_query method to properly format OR logic queries  
  - [x] Add support for complex queries with exclude keywords
  - [x] Add query validation and sanitization logic
  - [x] Update logging to track complex queries being executed

- [x] Task 2: Implement pagination handling (AC: 3)  
  - [x] Add pagination support in GoogleNewsSource integration
  - [x] Implement result fetching across multiple pages
  - [x] Add configurable limits for maximum results per search
  - [x] Handle pagination errors and empty results gracefully
  - [x] Add metrics tracking for pagination performance

- [x] Task 3: Enhance deduplication mechanism (AC: 4)
  - [x] Update ArticleRepository.bulk_create_with_enhanced_deduplication method 
  - [x] Improve URL hash-based deduplication across multiple keyword searches
  - [x] Add content similarity detection for near-duplicate articles
  - [x] Optimize deduplication queries for better performance
  - [x] Add deduplication statistics in crawl results

- [x] Task 4: Improve category association logic (AC: 5)
  - [x] Update category association in CrawlerEngine.save_articles_with_deduplication
  - [x] Add relevance scoring based on keyword matching
  - [x] Handle articles that match multiple categories
  - [x] Implement many-to-many article-category relationships properly
  - [x] Add category matching validation and logging

- [x] Task 5: Create comprehensive unit tests and integration tests
  - [x] Update tests/unit/test_core/test_crawler/test_engine.py with new multi-keyword scenarios
  - [x] Test OR logic query building with various keyword combinations
  - [x] Test pagination handling with mock GoogleNewsSource responses
  - [x] Test deduplication logic with articles from different keyword searches
  - [x] Test category association logic with multiple matching categories
  - [x] Create integration tests for complete multi-keyword crawl workflow

### Debug Log References
No critical issues encountered. All test cases pass (50/50 passing).

### Completion Notes
- Successfully implemented enhanced multi-keyword OR search functionality
- Added comprehensive pagination support with error handling
- Enhanced deduplication mechanism with content similarity detection
- Improved category association with relevance scoring
- Added 50 comprehensive test cases covering all new functionality
- All acceptance criteria met and validated through testing

### File List
**Modified Files:**
- `src/core/crawler/engine.py` - Enhanced with advanced multi-keyword search, pagination, relevance scoring, and category association logic
- `src/database/repositories/article_repo.py` - Added enhanced deduplication methods with detailed statistics
- `src/core/category/manager.py` - Enhanced search query building with validation and sanitization
- `tests/unit/test_core/test_crawler/test_engine.py` - Added comprehensive test coverage for all new functionality

**No New Files Created** - All enhancements implemented in existing files as specified in requirements.

## QA Results

### Review Date: 2025-09-12

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality with comprehensive feature coverage. The multi-keyword OR search functionality is well-architected with proper separation of concerns, robust error handling, and extensive test coverage. Code demonstrates mature software engineering practices with clear documentation, structured logging, and defensive programming patterns.

### Refactoring Performed

No refactoring required - code already follows best practices and architectural patterns.

### Compliance Check

- Coding Standards: ✓ **EXCELLENT** - Follows all naming conventions, async patterns, structured logging, and error handling standards
- Project Structure: ✓ **COMPLIANT** - Enhancements made to existing files as specified, no unnecessary file creation
- Testing Strategy: ✓ **EXCEPTIONAL** - 50 comprehensive test cases covering all scenarios including edge cases and error conditions
- All ACs Met: ✓ **COMPLETE** - All 5 acceptance criteria fully implemented and validated

### Test Coverage Analysis

**Requirements Traceability - All ACs Covered:**

- **AC1 (Multi-keyword arrays)**: ✓ Covered by `test_build_advanced_search_query_multiple_keywords` and related test methods
- **AC2 (OR logic implementation)**: ✓ Covered by advanced search query tests with Given-When-Then validation
- **AC3 (Pagination handling)**: ✓ Covered by comprehensive pagination test suite (15+ test methods)
- **AC4 (Deduplication)**: ✓ Covered by enhanced deduplication tests with statistics validation
- **AC5 (Category association)**: ✓ Covered by multi-category association tests with relevance scoring

**Test Quality Metrics:**
- Total test methods: 50
- Coverage areas: Unit (100%), Integration scenarios (covered), Error handling (comprehensive)
- Edge cases: Empty inputs, rate limiting, pagination errors, duplicate handling
- Performance scenarios: Query complexity classification, batch processing

### Security Review

**PASS** - No security concerns identified:
- Input sanitization properly implemented in `_sanitize_keywords` methods
- SQL injection prevention through parameterized queries
- No credential exposure or sensitive data logging
- Rate limiting implemented to prevent abuse

### Performance Considerations

**PASS** - Performance optimizations implemented:
- Query complexity classification for appropriate rate limiting
- Batch processing with configurable limits (default 50 articles)
- Pagination support to handle large result sets
- Semaphore-based concurrency control (max 5 concurrent extractions)
- Memory management through incremental processing

### Non-Functional Requirements Assessment

- **Reliability**: ✓ Comprehensive error handling with retry logic and graceful degradation
- **Scalability**: ✓ Pagination, rate limiting, and batch processing support high-volume operations
- **Maintainability**: ✓ Clear code structure, comprehensive documentation, extensive test coverage
- **Performance**: ✓ Efficient algorithms, resource management, and configurable limits

### Files Modified During Review

None - No modifications required during QA review.

### Gate Status

Gate: **PASS** → docs/qa/gates/2.2-multi-keyword-or-search.yml
Quality Score: 92/100 (Excellent)

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality, and full compliance with standards.

## Change Log

| Date       | Version | Description                                           | Author             |
| ---------- | ------- | ----------------------------------------------------- | ------------------ |
| 2025-09-11 | v1.0    | Initial story creation cho Multi-keyword OR Search    | Bob - Scrum Master |
| 2025-09-11 | v1.1    | Implementation completed - All tasks and tests pass  | James (Dev Agent)  |